<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MBC 기재실 휴가 종합</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase v10.12.2: 버전 통일 (app, firestore) -->
  <link rel="preload" as="script" href="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js" crossorigin>
  <link rel="preload" as="script" href="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js" crossorigin>

  <style>
    :root{
      --primary:#0ea5e9;
      --ink:#111827;
      --muted:#6b7280;
      --bg:#f8fafc;
      --panel:#ffffff;
      --line:#e5e7eb;
      --radius:14px;
      --red:#ef4444;
      --green:#10b981;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .btn{padding:.7rem 1rem;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff;border:none}
    .btn-danger{background:var(--red);color:#fff;border:none}
    .btn-ghost{background:#fff}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .hidden{display:none}
    .tag{display:inline-block;padding:.15rem .5rem;border-radius:9999px;border:1px solid var(--line);font-size:.8rem;color:var(--muted)}
    .row{display:flex;align-items:center;gap:.5rem;padding:.5rem .75rem;border-bottom:1px dashed var(--line)}
    .row:last-child{border-bottom:none}
    .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:.6rem .8rem;border-radius:10px;opacity:.95}
    .link{color:var(--primary);text-decoration:underline;cursor:pointer}
  </style>
</head>
<body>
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 id="title" class="text-xl font-semibold cursor-pointer">MBC 기재실 · 휴가 종합</h1>
      <nav class="flex gap-2">
        <button id="go-admin" class="btn">관리자</button>
        <button id="go-user" class="btn">사용자</button>
      </nav>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <!-- 홈 -->
    <section id="home" class="grid-2">
      <div class="card p-6 flex flex-col items-center justify-center text-center">
        <h2 class="text-lg font-semibold mb-2">관리자 페이지</h2>
        <p class="text-slate-500 mb-4">신청 현황 확인 · 승인/반려 · 사용자 관리</p>
        <button id="open-admin-login" class="btn btn-primary">관리자 로그인</button>
      </div>
      <div class="card p-6 flex flex-col items-center justify-center text-center">
        <h2 class="text-lg font-semibold mb-2">사용자 페이지</h2>
        <p class="text-slate-500 mb-4">휴가 신청 · 내 신청 현황</p>
        <button id="open-user-login" class="btn btn-primary">사용자 로그인</button>
      </div>
    </section>

    <!-- 관리자 -->
    <section id="admin" class="hidden">
      <div class="grid-2">
        <div class="card p-5">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">사용자 관리</h3>
            <span class="tag">users</span>
          </div>
          <form id="admin-add-user" class="flex gap-2 mb-3">
            <input id="new-user-name" class="flex-1 border rounded-md px-3 py-2" placeholder="이름(예: 홍길동)" required>
            <button class="btn btn-primary" type="submit">추가</button>
          </form>
          <div id="user-list" class="border rounded-md divide-y"></div>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <h3 class="font-semibold">휴가 신청 현황</h3>
              <input type="month" id="admin-month" class="border rounded-md px-3 py-1">
            </div>
            <span class="tag">vacationRequests</span>
          </div>
          <div id="admin-req-list" class="border rounded-md divide-y"></div>
        </div>
      </div>
    </section>

    <!-- 사용자 -->
    <section id="user" class="hidden">
      <div class="grid-2">
        <div class="card p-5">
          <h3 class="font-semibold mb-3">휴가 신청</h3>
          <form id="user-req-form" class="flex flex-col gap-2">
            <input type="date" id="req-date" required class="border rounded-md px-3 py-2">
            <input type="text" id="req-reason" required class="border rounded-md px-3 py-2" placeholder="사유">
            <button class="btn btn-primary" type="submit">신청</button>
          </form>
        </div>
        <div class="card p-5">
          <h3 class="font-semibold mb-3">내 신청 목록</h3>
          <div id="my-req-list" class="border rounded-md divide-y"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- 로그인 팝업 -->
  <div id="modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center p-4">
    <div class="card w-full max-w-md p-5">
      <h3 id="modal-title" class="font-semibold mb-3">로그인</h3>
      <form id="login-form" class="flex flex-col gap-2">
        <input id="login-name" class="border rounded-md px-3 py-2" placeholder="이름" required>
        <input id="login-pass" class="border rounded-md px-3 py-2" placeholder="비밀번호(기본 0000)" required>
        <div class="flex gap-2 justify-end">
          <button type="button" id="modal-cancel" class="btn btn-ghost">취소</button>
          <button class="btn btn-primary" type="submit">확인</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs,
      addDoc, updateDoc, deleteDoc,
      onSnapshot, query, where, orderBy, serverTimestamp, waitForPendingWrites
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // === Firebase Config (storageBucket 교정) ===
    const firebaseConfig = {
      apiKey: "AIzaSyACkd1QzPgDnmRz3b206e4IiePiS55keio",
      authDomain: "mbc-ingest.firebaseapp.com",
      databaseURL: "https://mbc-ingest-default-rtdb.firebaseio.com",
      projectId: "mbc-ingest",
      storageBucket: "mbc-ingest.appspot.com",
      messagingSenderId: "700019516",
      appId: "1:700019516:web:09f8b929973059316ea439"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 디버깅을 위해 오프라인 캐시 비활성화 상태 유지
    // import { enableIndexedDbPersistence } ... 후 enableIndexedDbPersistence(db) 를 쓰면
    // 로컬에서만 보이는 표면적 상태가 생길 수 있어 당분간 비권장.

    // === 상태 ===
    let session = { role: null, userId: null, userName: null };
    let unsubUsers = null, unsubAdminMonth = null, unsubMyRequests = null;
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    // === UI 공통 ===
    const showView = (id) => {
      for (const sec of ["home","admin","user"]) $(`#${sec}`).classList.add("hidden");
      $(`#${id}`).classList.remove("hidden");
    };
    const showToast = (msg) => {
      const el = $("#toast"); el.textContent = msg; el.classList.remove("hidden");
      setTimeout(()=> el.classList.add("hidden"), 2200);
    };
    const openModal = (title) => { $("#modal-title").textContent = title; $("#modal").classList.remove("hidden"); };
    const closeModal = () => { $("#modal").classList.add("hidden"); $("#login-form").reset(); };

    // === 라우팅 ===
    $("#title").addEventListener("click", ()=> showView("home"));
    $("#go-admin").addEventListener("click", ()=> openModal("관리자 로그인"));
    $("#go-user").addEventListener("click", ()=> openModal("사용자 로그인"));
    $("#open-admin-login").addEventListener("click", ()=> openModal("관리자 로그인"));
    $("#open-user-login").addEventListener("click", ()=> openModal("사용자 로그인"));
    $("#modal-cancel").addEventListener("click", closeModal);

    // === 로그인 ===
    $("#login-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const name = $("#login-name").value.trim();
      const pass = $("#login-pass").value.trim();

      if ($("#modal-title").textContent.includes("관리자")) {
        // 데모: 고정 관리자 (보안은 운영에서 Auth 사용)
        if (name === "admin" && pass === "dlgmdfyd890!") {
          session = { role: "admin", userId: null, userName: "ADMIN" };
          closeModal(); bindAdmin(); showView("admin");
          showToast("관리자 로그인 완료");
        } else {
          alert("관리자 인증 실패");
        }
      } else {
        // 사용자: users 컬렉션에서 이름/비번 확인
        try {
          const snap = await getDocs(collection(db, "users"));
          const hit = snap.docs.find(d => {
            const u = d.data();
            return (u.name === name && u.password === pass);
          });
          if (!hit) { alert("사용자 인증 실패 (이름/비번 확인)"); return; }
          session = { role: "user", userId: hit.id, userName: hit.data().name };
          closeModal(); bindUser(); showView("user");
          showToast(`${session.userName}님 환영합니다`);
        } catch (err) {
          console.error("사용자 로그인 실패:", err);
          alert("로그인 중 오류가 발생했습니다 (콘솔 참조).");
        }
      }
    });

    // === 관리자 바인딩 ===
    function unbindAll(){
      if (unsubUsers) { unsubUsers(); unsubUsers = null; }
      if (unsubAdminMonth) { unsubAdminMonth(); unsubAdminMonth = null; }
      if (unsubMyRequests) { unsubMyRequests(); unsubMyRequests = null; }
    }

    async function bindAdmin(){
      unbindAll();
      // users 실시간
      const list = $("#user-list");
      unsubUsers = onSnapshot(collection(db, "users"), (snap)=>{
        list.innerHTML = "";
        snap.forEach(docu=>{
          const u = { id: docu.id, ...docu.data() };
          const row = document.createElement("div");
          row.className = "row";
          row.innerHTML = `
            <div class="flex-1">
              <div class="font-medium">${u.name}</div>
              <div class="text-sm text-slate-500">비밀번호: ${u.password}</div>
            </div>
            <button class="btn btn-danger" data-del="${u.id}">삭제</button>
          `;
          list.appendChild(row);
        });
      }, (err)=>{
        console.error("users 구독 실패:", err);
        alert("users 읽기 실패(규칙/네트워크 확인). 콘솔 확인.");
      });

      // 월별 휴가 실시간
      const monthInput = $("#admin-month");
      const syncMonth = ()=>{
        const v = monthInput.value || new Date().toISOString().slice(0,7); // YYYY-MM
        monthInput.value = v;
        const [y,m] = v.split("-");
        const start = `${y}-${m}-01`;
        const end = `${y}-${m}-31`;
        if (unsubAdminMonth) { unsubAdminMonth(); unsubAdminMonth = null; }

        const q = query(
          collection(db, "vacationRequests"),
          where("date", ">=", start),
          where("date", "<=", end),
          orderBy("date", "asc"),
          orderBy("createdAt", "asc")
        );

        unsubAdminMonth = onSnapshot(q, (snap)=>{
          const box = $("#admin-req-list");
          box.innerHTML = "";
          snap.forEach(docu=>{
            const r = { id: docu.id, ...docu.data() };
            const row = document.createElement("div");
            row.className = "row";
            row.innerHTML = `
              <div class="flex-1">
                <div class="font-medium">${r.date} · ${r.userName}</div>
                <div class="text-sm text-slate-500">${r.reason}</div>
              </div>
              <span class="tag">${r.status}</span>
              <button class="btn" data-approve="${r.id}">승인</button>
              <button class="btn" data-reject="${r.id}">반려</button>
            `;
            box.appendChild(row);
          });
        }, (err)=>{
          console.error("vacationRequests 월별 구독 실패:", err);
          alert("휴가 목록 로딩 실패. Firestore 인덱스 필요 메시지가 콘솔에 뜨면 링크로 인덱스를 생성하세요.");
        });
      };
      monthInput.addEventListener("change", syncMonth);
      syncMonth();
    }

    // 관리자: 사용자 추가/삭제/승인/반려
    $("#admin-add-user").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const name = $("#new-user-name").value.trim();
      if (!name) return;
      try {
        // 중복명 방지(간단 체크)
        const existSnap = await getDocs(collection(db,"users"));
        if (existSnap.docs.some(d => (d.data().name === name))) {
          alert("이미 존재하는 이름입니다.");
          return;
        }
        await addDoc(collection(db,"users"), { name, password:"0000", createdAt: serverTimestamp() });
        await waitForPendingWrites(db);
        $("#new-user-name").value = "";
        showToast(`사용자 '${name}' 추가됨`);
      } catch (err) {
        console.error("사용자 추가 실패:", err);
        alert("사용자 추가 실패(권한/네트워크/규칙 확인). 콘솔 참조.");
      }
    });

    $("#user-list").addEventListener("click", async (e)=>{
      const id = e.target?.dataset?.del;
      if (!id) return;
      if (!confirm("정말 삭제하시겠습니까?")) return;
      try {
        await deleteDoc(doc(db,"users",id));
        await waitForPendingWrites(db);
        showToast("삭제 완료");
      } catch (err) {
        console.error("사용자 삭제 실패:", err);
        alert("삭제 실패(권한/규칙). 콘솔 참조.");
      }
    });

    $("#admin-req-list").addEventListener("click", async (e)=>{
      const approveId = e.target?.dataset?.approve;
      const rejectId = e.target?.dataset?.reject;
      try {
        if (approveId) {
          await updateDoc(doc(db,"vacationRequests",approveId), { status:"approved", updatedAt: serverTimestamp() });
          await waitForPendingWrites(db);
          showToast("승인 완료");
        } else if (rejectId) {
          const reason = prompt("반려 사유 입력:");
          await updateDoc(doc(db,"vacationRequests",rejectId), { status:"rejected", rejectReason: reason || "", updatedAt: serverTimestamp() });
          await waitForPendingWrites(db);
          showToast("반려 처리 완료");
        }
      } catch (err) {
        console.error("승인/반려 실패:", err);
        alert("승인/반려 실패(권한/규칙). 콘솔 참조.");
      }
    });

    // === 사용자 바인딩 ===
    function bindUser(){
      unbindAll();
      if (!session.userId) { alert("로그인 필요"); return; }

      // 내 신청 목록 실시간
      unsubMyRequests = onSnapshot(
        query(
          collection(db,"vacationRequests"),
          where("userId","==", session.userId),
          orderBy("date","desc"),
          orderBy("createdAt","desc")
        ),
        (snap)=>{
          const box = $("#my-req-list"); box.innerHTML = "";
          snap.forEach(docu=>{
            const r = { id: docu.id, ...docu.data() };
            const row = document.createElement("div");
            row.className = "row";
            row.innerHTML = `
              <div class="flex-1">
                <div class="font-medium">${r.date} · ${r.status}</div>
                <div class="text-sm text-slate-500">${r.reason}</div>
              </div>
            `;
            box.appendChild(row);
          });
        },
        (err)=>{
          console.error("내 신청 구독 실패:", err);
          alert("내 신청 목록 로딩 실패. 콘솔 참조.");
        }
      );
    }

    // 사용자: 휴가 신청
    $("#user-req-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      if (!session.userId) { alert("로그인 필요"); return; }
      const date = $("#req-date").value;
      const reason = $("#req-reason").value.trim();
      if (!date || !reason) return;
      try {
        await addDoc(collection(db,"vacationRequests"), {
          userId: session.userId,
          userName: session.userName,
          date, reason,
          status: "pending",
          createdAt: serverTimestamp()
        });
        await waitForPendingWrites(db);
        $("#user-req-form").reset();
        showToast("신청 완료");
      } catch (err) {
        console.error("휴가 신청 실패:", err);
        alert("휴가 신청 실패(권한/규칙). 콘솔 참조.");
      }
    });

    // 초기 진입
    showView("home");
  </script>
</body>
</html>
